<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas Data API</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #2d3b45;
            border-bottom: 2px solid #e6e6e6;
            padding-bottom: 10px;
        }
        h2 {
            color: #2d3b45;
            margin-top: 30px;
        }
        .endpoint {
            background-color: #f5f5f5;
            border-left: 4px solid #0374B5;
            padding: 10px 15px;
            margin: 15px 0;
            border-radius: 0 4px 4px 0;
        }
        .endpoint h3 {
            margin-top: 0;
            color: #0374B5;
        }
        code {
            background-color: #f1f1f1;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
        }
        .btn {
            display: inline-block;
            background-color: #0374B5;
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            border-radius: 4px;
            margin-top: 10px;
            font-weight: 500;
        }
        .btn:hover {
            background-color: #025E92;
        }
        .description {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <h1>Canvas Data API</h1>
    <p class="description">
        This API server provides access to Canvas LMS data using your Canvas API key.
        Below are the available endpoints you can use to retrieve data.
    </p>

    <div class="endpoint">
        <h3>Get All Data</h3>
        <code>GET /api/all-data</code>
        <p>
            Fetches all available Canvas data for the authenticated user, including user information,
            courses, assignments, submissions, modules, discussions, files, pages, announcements,
            calendar events, conversations, todo items, and grades.
        </p>
        <p>
            <strong>Performance Timing:</strong> This endpoint includes detailed timing information showing
            how long each section of data takes to fetch. The total time is displayed in the response.
        </p>
        <a href="/api/all-data" class="btn" target="_blank">Try it</a>
        <div id="timing-display" style="margin-top: 15px; display: none;">
            <h4>Last Request Timing</h4>
            <div id="timing-content"></div>
        </div>
    </div>

    <script>
        // Add a click handler to the "Try it" button for all-data
        document.querySelector('.endpoint a[href="/api/all-data"]').addEventListener('click', function(e) {
            e.preventDefault();

            const timingDisplay = document.getElementById('timing-display');
            const timingContent = document.getElementById('timing-content');

            // Show loading message
            timingDisplay.style.display = 'block';
            timingContent.innerHTML = '<p>Loading data... This may take a while.</p>';

            // Make the API request
            fetch('/api/all-data')
                .then(response => response.json())
                .then(data => {
                    // Display timing information
                    if (data.timing) {
                        const timing = data.timing;
                        let html = `
                            <p><strong>Total time:</strong> ${timing.totalTimeFormatted} (${timing.totalTimeSec} seconds)</p>
                            <p><strong>Started:</strong> ${new Date(timing.startTime).toLocaleTimeString()}</p>
                            <p><strong>Completed:</strong> ${new Date(timing.endTime).toLocaleTimeString()}</p>

                            <h5>Section Timings:</h5>
                            <ul>
                        `;

                        // Add section timings
                        for (const [section, sectionTiming] of Object.entries(timing.sections)) {
                            html += `<li><strong>${section}:</strong> ${sectionTiming.timeSec} seconds</li>`;
                        }

                        html += `</ul>`;

                        // Add course timings if available
                        if (data.courses && data.courses.length > 0) {
                            html += `
                                <h5>Course Processing Times:</h5>
                                <ul>
                            `;

                            data.courses.forEach(course => {
                                if (course.timing) {
                                    html += `<li><strong>${course.name}:</strong> ${course.timing.totalTimeSec} seconds</li>`;
                                }
                            });

                            html += `</ul>`;
                        }

                        timingContent.innerHTML = html;

                        // Open the data in a new tab
                        window.open('/api/all-data', '_blank');
                    } else {
                        timingContent.innerHTML = '<p>No timing information available.</p>';
                    }
                })
                .catch(error => {
                    timingContent.innerHTML = `<p>Error: ${error.message}</p>`;
                });
        });
    </script>

    <h2>Individual Endpoints</h2>

    <div class="endpoint">
        <h3>User Information</h3>
        <code>GET /api/user</code>
        <p>Get information about the current user.</p>
        <a href="/api/user" class="btn" target="_blank">Try it</a>
    </div>

    <div class="endpoint">
        <h3>Courses</h3>
        <code>GET /api/courses</code>
        <p>Get all courses for the current user.</p>
        <a href="/api/courses" class="btn" target="_blank">Try it</a>
    </div>

    <div class="endpoint">
        <h3>Course Assignments</h3>
        <code>GET /api/courses/:courseId/assignments</code>
        <p>Get all assignments for a specific course.</p>
        <p><em>Note: Replace :courseId with an actual course ID.</em></p>
    </div>

    <div class="endpoint">
        <h3>Assignment Submissions</h3>
        <code>GET /api/courses/:courseId/assignments/:assignmentId/submissions</code>
        <p>Get all submissions for a specific assignment.</p>
        <p><em>Note: Replace :courseId and :assignmentId with actual IDs.</em></p>
    </div>

    <div class="endpoint">
        <h3>Announcements</h3>
        <code>GET /api/announcements</code>
        <p>Get all announcements for the current user.</p>
        <a href="/api/announcements" class="btn" target="_blank">Try it</a>
    </div>

    <div class="endpoint">
        <h3>Calendar Events</h3>
        <code>GET /api/calendar_events</code>
        <p>Get all calendar events for the current user.</p>
        <a href="/api/calendar_events" class="btn" target="_blank">Try it</a>
    </div>

    <div class="endpoint">
        <h3>Todo Items</h3>
        <code>GET /api/todo</code>
        <p>Get all todo items for the current user.</p>
        <a href="/api/todo" class="btn" target="_blank">Try it</a>
    </div>

    <div class="endpoint">
        <h3>Grades</h3>
        <code>GET /api/grades</code>
        <p>Get grades for all courses for the current user.</p>
        <a href="/api/grades" class="btn" target="_blank">Try it</a>
    </div>

    <h2>Notes</h2>
    <p>
        This server handles pagination automatically for all Canvas API requests.
        All data is returned in JSON format. Error handling is implemented for all endpoints.
    </p>
    <p>
        The server handles permission errors (403) gracefully. This is important because Canvas
        restricts access to certain data based on user roles. For example, students typically
        cannot access other students' submissions, so 403 errors are expected for those endpoints.
    </p>
</body>
</html>
